<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHƯƠNG TRÌNH LẬP LỆNH XUẤT HÀNG</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        #login-form-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #login-form-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        #login-form-container .form-group {
            margin-bottom: 15px;
        }

        #login-form-container input[type="email"],
        #login-form-container input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        #login-form-container button {
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #login-form-container button:hover {
            background-color: #2980b9;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        header img {
            margin-right: 20px;
        }

        header h1 {
            margin: 0;
            color: #2ecc71;
            text-align: center;
        }

        h2 {
            color: #2c3e50;
        }

        .input-section, .list-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button.delete-btn {
            background-color: #e74c3c;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }

        button.delete-all-btn {
            background-color: #e74c3c;
            padding: 10px 15px;
            font-size: 16px;
        }
        
        button.order-btn {
            background-color: #2ecc71;
            padding: 5px 10px;
            font-size: 14px;
        }

        button.print-btn {
            background-color: #f39c12;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }

        button.edit-btn {
            background-color: #3498db;
            padding: 5px 10px;
            font-size: 14px;
        }

        button.statistics-btn {
            background-color: #9b59b6;
            padding: 10px 15px;
            font-size: 16px;
        }
        
        button.import-orders-btn {
            background-color: #2c3e50;
            padding: 10px 15px;
            font-size: 16px;
        }
        
        button.lock-orders-btn {
            background-color: #f39c12; 
        }
        
        button.lock-orders-btn:hover {
            background-color: #e67e22;
        }
        
        tr.locked-order {
            opacity: 0.6;
            background-color: #f2f2f2 !important; 
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        button.delete-btn:hover, button.delete-all-btn:hover {
            background-color: #c0392b;
        }

        button.order-btn:hover {
            background-color: #27ae60;
        }

        button.print-btn:hover {
            background-color: #e67e22;
        }

        button.edit-btn:hover {
            background-color: #2980b9;
        }
        
        button.statistics-btn:hover {
            background-color: #8e44ad;
        }
        
        button.import-orders-btn:hover {
            background-color: #1e252e;
        }

        button:hover {
            background-color: #2980b9;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .list-header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .statistics-section {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .statistics-section .form-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .statistics-section .form-group label {
            min-width: 150px;
        }

        .statistics-section .form-group input {
            flex-grow: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            word-wrap: break-word;
        }
        
        td:last-child {
            text-align: center;
        }
        
        td .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        th.checkbox-col, td.checkbox-col {
            width: 40px;
            text-align: center;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .hidden {
            display: none;
        }

        .pagination-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .pagination-controls button {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .order-form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .order-form-container .form-group label {
            width: 150px;
            display: inline-block;
        }

        .order-form-container .form-group input {
            width: calc(100% - 160px);
        }
    </style>
</head>
<body>
    
    <div id="login-form-container">
        <h2>Đăng nhập để truy cập</h2>
        <div class="form-group">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" value="m*****@pvgaslpg.com.vn" readonly>
        </div>
        <div class="form-group">
            <label for="login-password">Mật khẩu:</label>
            <input type="password" id="login-password">
        </div>
        <button id="login-btn">Đăng nhập</button>
    </div>
    <div class="container" id="main-content">
        <header>
            <img src="https://pvgaslpg.com.vn/uploads/LPG%20xanh%20animation.gif" alt="Logo PV Gas LPG" width="150" height="150">
            <h1>CHƯƠNG TRÌNH LẬP LỆNH XUẤT HÀNG</h1>
        </header>

        <div id="customer-view">
            <section class="list-section">
                <div class="list-header">
                    <h2>Danh sách khách hàng</h2>
                    <div class="list-header-buttons">
                        <button id="showAddCustomerViewBtn">Thêm khách hàng</button>
                        <button id="exportBtn">Xuất ra Excel</button>
                        <button id="deleteAllCustomersBtn" class="delete-all-btn">Xoá toàn bộ KH</button>
                        <button id="viewOrdersBtn">Xem danh sách lệnh</button>
                    </div>
                </div>
                
                <table id="customerTable">
                    <thead>
                        <tr>
                            <th>Thứ tự</th>
                            <th>Mã số</th>
                            <th>Tên khách hàng</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>
        </div>

        <div id="add-customer-view" class="hidden">
            <section class="input-section">
                <h2>Thêm khách hàng vào dữ liệu</h2>
                <div class="form-group">
                    <label for="customerId">Mã số khách hàng:</label>
                    <input type="text" id="customerId" placeholder="Mã số">
                </div>
                <div class="form-group">
                    <label for="customerName">Tên khách hàng:</label>
                    <input type="text" id="customerName" placeholder="Tên khách hàng">
                </div>
                <button id="saveBtn">Lưu khách hàng</button>
            </section>

            <section class="input-section">
                <h2>Hoặc nhập từ Excel</h2>
                <button id="importBtn">Nhập từ Excel</button>
                <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none;">
            </section>
            
            <button id="backToCustomerListBtn3">Quay lại</button>
        </div>

        <div id="order-form-view" class="hidden">
            <section class="input-section">
                <h2 style="color: #3498db; margin-bottom: 20px;">Tạo Lệnh Xuất Hàng cho khách hàng: <span id="orderCustomerName" style="color: blue;"></span></h2>
                <div class="order-form-container">
                    <div class="left-column">
                        <div class="form-group">
                            <label for="orderDate">Ngày tháng:</label>
                            <input type="text" id="orderDate" placeholder="dd/mm/yyyy" value="">
                        </div>
                        <div class="form-group">
                            <label for="orderWarehouse">Kho xuất:</label>
                            <input type="text" id="orderWarehouse">
                        </div>
                        <div class="form-group">
                            <label for="orderTransporter">Người vận chuyển:</label>
                            <input type="text" id="orderTransporter">
                        </div>
                        <div class="form-group">
                            <label for="orderVehicle">Số xe:</label>
                            <input type="text" id="orderVehicle">
                        </div>
                        <div class="form-group">
                            <label for="orderDeliveryLocation">Địa điểm giao hàng:</label>
                            <input type="text" id="orderDeliveryLocation">
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="form-group">
                            <label for="orderLpg45kg">LPG chai 45 kg:</label>
                            <input type="number" id="orderLpg45kg" value="0">
                        </div>
                        <div class="form-group">
                            <label for="orderL45dual">LPG chai 45 van kép:</label>
                            <input type="number" id="orderL45dual" value="0">
                        </div>
                        <div class="form-group">
                            <label for="orderLpg12kg">LPG chai 12 kg:</label>
                            <input type="number" id="orderLpg12kg" value="0">
                        </div>
                        <div class="form-group">
                            <label for="orderLpg11kg">LPG chai 11 kg:</label>
                            <input type="number" id="orderLpg11kg" value="0">
                        </div>
                        <div class="form-group">
                            <label for="order45kg">Chai 45 kg:</label>
                            <input type="number" id="order45kg" value="0">
                        </div>
                        <div class="form-group">
                            <label for="orderch45Dual">Chai 45 kg van kép:</label>
                            <input type="number" id="orderch45Dual" value="0">
                        </div>
                        <div class="form-group">
                            <label for="order12kg">Chai 12 kg:</label>
                            <input type="number" id="order12kg" value="0">
                        </div>
                        <div class="form-group">
                            <label for="order11kg">Chai 11 kg:</label>
                            <input type="number" id="order11kg" value="0">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button id="submitOrderBtn">Lưu lệnh</button>
                    <button id="backToCustomerListBtn">Quay lại</button>
                </div>
            </section>
        </div>

        <div id="order-list-view" class="hidden">
            <section class="list-section">
                <div class="list-header">
                    <h2>Danh sách các Lệnh Xuất Hàng</h2>
                    <div class="list-header-buttons">
                        <button id="selectAllOrdersBtn">Chọn tất cả</button> 
                        <button id="lockOrdersBtn" class="lock-orders-btn">Khoá lệnh</button> 
                        <button id="importOrdersBtn" class="import-orders-btn">Nhập danh sách lệnh</button>
                        <input type="file" id="excelOrderFile" accept=".xlsx, .xls" style="display:none;">
                        <button id="showStatisticsBtn" class="statistics-btn">Xuất DS lệnh</button>
                        <button id="deleteAllOrdersBtn" class="delete-all-btn">Xoá tất cả các lệnh</button>
                        <button id="backToCustomerListBtn2">Quay lại</button>
                    </div>
                </div>
                
                <table id="orderTable">
                    <thead>
                        <tr>
                            <th class="checkbox-col">Chọn</th> 
                            <th>Thứ tự</th>
                            <th>Tên Khách hàng</th>
                            <th>Ngày tháng</th>
                            <th>Kho xuất</th>
                            <th>Số xe</th>
                            <th>LPG 45 kg</th>
                            <th>LPG 45 kép</th>
                            <th>LPG 12 kg</th>
                            <th>LPG 11 kg</th>
                            <th>Chai 45 kg</th>
                            <th>45 kg van kép</th>
                            <th>Chai 12 kg</th>
                            <th>Chai 11 kg</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                <div class="pagination-controls">
                    <button id="prevPageBtn">Trang trước</button>
                    <span id="pageInfo">Trang 1/1</span>
                    <button id="nextPageBtn">Trang sau</button>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getDatabase, ref, set, get, onValue, 
            update, remove, push, query, orderByChild, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        
        const mainContent = document.getElementById('main-content');
        const loginFormContainer = document.getElementById('login-form-container');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');

        const firebaseConfig = {
          apiKey: "AIzaSyAPXZaRlQIiUttyjeANUTnJzLPujrah8nk",
          authDomain: "lxh-rtime.firebaseapp.com",
          databaseURL: "https://lxh-rtime-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "lxh-rtime",
          storageBucket: "lxh-rtime.firebasestorage.app",
          messagingSenderId: "982449495226",
          appId: "1:982449495226:web:31abb3c1b483a6ec283683",
          measurementId: "G-3PJGRVJFPG"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        const db = getDatabase(app);
        const auth = getAuth(app);
        
        const handleLogin = async () => {
            const email = "mydinh@pvgaslpg.com.vn";
            const password = loginPasswordInput.value;

            if (!password) {
                alert('Vui lòng nhập mật khẩu.');
                return;
            }

            loginFormContainer.style.display = 'none';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Đăng nhập thành công:', userCredential.user);
                mainContent.style.display = 'block';
            } catch (error) {
                console.error('Lỗi đăng nhập:', error.code, error.message);
                alert('Đăng nhập không thành công. Vui lòng kiểm tra lại mật khẩu.');
                loginFormContainer.style.display = 'block';
            }
        };

        loginBtn.addEventListener('click', handleLogin);

        loginPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleLogin();
            }
        });

        const customerView = document.getElementById('customer-view');
        const addCustomerView = document.getElementById('add-customer-view');
        const orderFormView = document.getElementById('order-form-view');
        const orderListView = document.getElementById('order-list-view');

        const customerIdInput = document.getElementById('customerId');
        const customerNameInput = document.getElementById('customerName');
        const saveBtn = document.getElementById('saveBtn');
        const importBtn = document.getElementById('importBtn');
        const excelFile = document.getElementById('excelFile');

        const showAddCustomerViewBtn = document.getElementById('showAddCustomerViewBtn');
        const backToCustomerListBtn3 = document.getElementById('backToCustomerListBtn3');
        const exportBtn = document.getElementById('exportBtn');
        const deleteAllCustomersBtn = document.getElementById('deleteAllCustomersBtn');
        const customerTableBody = document.querySelector('#customerTable tbody');
        const viewOrdersBtn = document.getElementById('viewOrdersBtn');

        const orderCustomerName = document.getElementById('orderCustomerName');
        const orderDateInput = document.getElementById('orderDate');
        const orderWarehouseInput = document.getElementById('orderWarehouse');
        const orderTransporterInput = document.getElementById('orderTransporter');
        const orderVehicleInput = document.getElementById('orderVehicle');
        const orderDeliveryLocationInput = document.getElementById('orderDeliveryLocation');
        const orderLpg45kgInput = document.getElementById('orderLpg45kg');
        const orderL45dualInput = document.getElementById('orderL45dual');
        const orderLpg12kgInput = document.getElementById('orderLpg12kg');
        const orderLpg11kgInput = document.getElementById('orderLpg11kg');
        const order45kgInput = document.getElementById('order45kg');
        const orderch45DualInput = document.getElementById('orderch45Dual');
        const order12kgInput = document.getElementById('order12kg');
        const order11kgInput = document.getElementById('order11kg');
        const submitOrderBtn = document.getElementById('submitOrderBtn');
        const backToCustomerListBtn = document.getElementById('backToCustomerListBtn');
        const orderTableBody = document.querySelector('#orderTable tbody');
        const backToCustomerListBtn2 = document.getElementById('backToCustomerListBtn2');
        const deleteAllOrdersBtn = document.getElementById('deleteAllOrdersBtn');
        const showStatisticsBtn = document.getElementById('showStatisticsBtn');
        const importOrdersBtn = document.getElementById('importOrdersBtn');
        const excelOrderFile = document.getElementById('excelOrderFile');
        const lockOrdersBtn = document.getElementById('lockOrdersBtn'); 
        const selectAllOrdersBtn = document.getElementById('selectAllOrdersBtn'); 
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfoSpan = document.getElementById('pageInfo');

        const ITEMS_PER_PAGE = 50;
        let currentPage = 1;
        let allOrders = [];

        let customerData = [];
        let currentCustomerId = '';
        let currentOrderKey = null;
        
        const showCustomerList = () => {
            customerView.classList.remove('hidden');
            addCustomerView.classList.add('hidden');
            orderFormView.classList.add('hidden');
            orderListView.classList.add('hidden');
            currentOrderKey = null;
            submitOrderBtn.textContent = 'Lưu lệnh';
        };

        const showAddCustomerView = () => {
            customerView.classList.add('hidden');
            addCustomerView.classList.remove('hidden');
            orderFormView.classList.add('hidden');
            orderListView.classList.add('hidden');
        };

        const showOrderForm = (customerId, customerName) => {
            currentCustomerId = customerId;
            orderCustomerName.textContent = customerName;
            orderDateInput.value = new Date().toLocaleDateString('vi-VN');
            orderWarehouseInput.value = 'KHO MỸ ĐÌNH';
            orderTransporterInput.value = '';
            orderVehicleInput.value = '';
            orderDeliveryLocationInput.value = '';
            orderLpg45kgInput.value = '0';
            orderL45dualInput.value = '0';
            orderLpg12kgInput.value = '0';
            orderLpg11kgInput.value = '0';
            order45kgInput.value = '0';
            orderch45DualInput.value = '0';
            order12kgInput.value = '0';
            order11kgInput.value = '0';
            
            setupOrderInputFields();
            
            customerView.classList.add('hidden');
            addCustomerView.classList.add('hidden');
            orderFormView.classList.remove('hidden');
            orderListView.classList.add('hidden');
        };
        
        const showEditOrderForm = (orderKey, order) => {
            currentOrderKey = orderKey;
            orderCustomerName.textContent = order.customerName;
            orderDateInput.value = order.date;
            orderWarehouseInput.value = order.warehouse;
            orderTransporterInput.value = order.transporter;
            orderVehicleInput.value = order.vehicle;
            orderDeliveryLocationInput.value = order.deliveryLocation || '';
            orderLpg45kgInput.value = order.lpg45kg;
            orderL45dualInput.value = order.L45dual;
            orderLpg12kgInput.value = order.lpg12kg;
            orderLpg11kgInput.value = order.lpg11kg;
            order45kgInput.value = order.chai45kg;
            orderch45DualInput.value = order.ch45Dual;
            order12kgInput.value = order.chai12kg;
            order11kgInput.value = order.chai11kg;
            
            submitOrderBtn.textContent = 'Cập nhật lệnh';
            
            setupOrderInputFields();

            customerView.classList.add('hidden');
            addCustomerView.classList.add('hidden');
            orderFormView.classList.remove('hidden');
            orderListView.classList.add('hidden');
        };
        
        const showOrderList = () => {
            customerView.classList.add('hidden');
            addCustomerView.classList.add('hidden');
            orderFormView.classList.add('hidden');
            orderListView.classList.remove('hidden');
        };
        
        showAddCustomerViewBtn.addEventListener('click', showAddCustomerView);
        backToCustomerListBtn.addEventListener('click', showCustomerList);
        backToCustomerListBtn2.addEventListener('click', showCustomerList);
        backToCustomerListBtn3.addEventListener('click', showCustomerList);
        viewOrdersBtn.addEventListener('click', showOrderList);

        saveBtn.addEventListener('click', async () => {
            const customerId = customerIdInput.value.trim();
            const customerName = customerNameInput.value.trim();

            if (customerId === '' || customerName === '') {
                alert('Vui lòng nhập đầy đủ Mã số và Tên khách hàng.');
                return;
            }

            const safeCustomerId = customerId.replace(/[.#$[\]]/g, '');
            if (safeCustomerId === '') {
                alert('Mã số khách hàng không hợp lệ. Vui lòng không sử dụng các ký tự đặc biệt như ., #, $, [, ].');
                return;
            }
            
            const customerRef = ref(db, 'customers/' + safeCustomerId);
            try {
                const snapshot = await get(customerRef);
                if (snapshot.exists()) {
                    alert('Mã khách hàng đã tồn tại. Vui lòng nhập mã khác.');
                    return;
                }
            } catch (error) {
                alert('Lỗi khi kiểm tra dữ liệu: ' + error.message);
                return;
            }

            set(customerRef, {
                id: safeCustomerId,
                originalId: customerId,
                name: customerName
            })
            .then(() => {
                alert('Lưu khách hàng thành công!');
                customerIdInput.value = '';
                customerNameInput.value = '';
                showCustomerList();
            })
            .catch((error) => {
                alert('Đã xảy ra lỗi khi lưu khách hàng: ' + error.message);
            });
        });
        
        const deleteCustomer = (customerIdKey) => {
            const password = prompt('Vui lòng nhập mật khẩu để xóa:');
            if (password === '54321') {
                remove(ref(db, 'customers/' + customerIdKey))
                .then(() => {
                    alert('Đã xóa khách hàng thành công!');
                })
                .catch((error) => {
                    alert('Đã xảy ra lỗi khi xóa khách hàng: ' + error.message);
                });
            } else {
                alert('Mật khẩu không đúng. Vui lòng thử lại.');
            }
        };

        deleteAllCustomersBtn.addEventListener('click', async () => {
            const password = prompt('CẢNH BÁO: Thao tác này sẽ xóa toàn bộ danh sách khách hàng. Vui lòng nhập mật khẩu để xác nhận:');
            if (password === '54321') {
                remove(ref(db, 'customers'))
                .then(() => {
                    alert('Đã xóa toàn bộ danh sách khách hàng thành công!');
                })
                .catch((error) => {
                    alert('Đã xảy ra lỗi khi xóa toàn bộ danh sách: ' + error.message);
                });
            } else {
                alert('Mật khẩu không đúng. Vui lòng thử lại.');
            }
        });

        const customersQuery = query(ref(db, 'customers'), orderByChild('originalId'));
        onValue(customersQuery, (snapshot) => {
            customerData = [];
            customerTableBody.innerHTML = '';
            let index = 1;
            const customers = [];

            if (snapshot.exists()) {
                const customersObject = snapshot.val();
                for (const key in customersObject) {
                    customers.push({ key: key, ...customersObject[key] });
                }
            }
            
            customers.sort((a, b) => (a.originalId || a.id).localeCompare(b.originalId || b.id));

            customers.forEach((customer) => {
                const displayedId = customer.originalId || customer.id;
                customerData.push({
                    'Thứ tự': index,
                    'Mã số': displayedId,
                    'Tên khách hàng': customer.name
                });

                const row = customerTableBody.insertRow();
                row.insertCell(0).textContent = index++;
                row.insertCell(1).textContent = displayedId;
                row.insertCell(2).textContent = customer.name;
                
                const actionsCell = row.insertCell(3);
                actionsCell.classList.add('action-buttons');

                const orderBtn = document.createElement('button');
                orderBtn.textContent = 'Lệnh XH';
                orderBtn.className = 'order-btn';
                orderBtn.addEventListener('click', () => {
                    showOrderForm(customer.id, customer.name);
                });
                actionsCell.appendChild(orderBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Xoá';
                deleteBtn.className = 'delete-btn';
                deleteBtn.addEventListener('click', () => {
                    deleteCustomer(customer.key);
                });
                actionsCell.appendChild(deleteBtn);
            });
        });

        importBtn.addEventListener('click', () => { excelFile.click(); });
        excelFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const importedData = XLSX.utils.sheet_to_json(worksheet);

                if (importedData.length > 0) {
                    const updates = {};
                    importedData.forEach(row => {
                        const originalId = row['Mã số'];
                        const customerName = row['Tên khách hàng'];
                        if (originalId && customerName) {
                            const safeCustomerId = String(originalId).trim().replace(/[.#$[\]]/g, '');
                            if (safeCustomerId) {
                                const customerPayload = {
                                    id: safeCustomerId,
                                    originalId: String(originalId).trim(),
                                    name: customerName
                                };
                                updates['/customers/' + safeCustomerId] = customerPayload;
                            }
                        }
                    });

                    update(ref(db), updates)
                        .then(() => { 
                            alert(`Đã nhập thành công ${Object.keys(updates).length} khách hàng từ file Excel!`); 
                            showCustomerList();
                        })
                        .catch(error => { alert("Đã xảy ra lỗi khi nhập dữ liệu: " + error.message); });
                } else {
                    alert('File Excel không có dữ liệu hoặc cấu trúc không đúng.');
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        exportBtn.addEventListener('click', () => {
            if (customerData.length === 0) {
                alert('Không có dữ liệu để xuất ra file Excel.');
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(customerData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "DanhSachKhachHang");
            XLSX.writeFile(workbook, "danh-sach-khach-hang.xlsx");
        });

        submitOrderBtn.addEventListener('click', () => {
            const orderData = {
                customerId: currentCustomerId,
                date: orderDateInput.value,
                warehouse: orderWarehouseInput.value,
                transporter: orderTransporterInput.value,
                vehicle: orderVehicleInput.value,
                deliveryLocation: orderDeliveryLocationInput.value,
                lpg45kg: Number(orderLpg45kgInput.value) || 0,
                L45dual: Number(orderL45dualInput.value) || 0,
                lpg12kg: Number(orderLpg12kgInput.value) || 0,
                lpg11kg: Number(orderLpg11kgInput.value) || 0,
                chai45kg: Number(order45kgInput.value) || 0,
                ch45Dual: Number(orderch45DualInput.value) || 0,
                chai12kg: Number(order12kgInput.value) || 0,
                chai11kg: Number(order11kgInput.value) || 0,
                customerName: orderCustomerName.textContent
            };
            
            if (!orderData.date || !orderData.transporter || !orderData.vehicle) {
                alert("Vui lòng nhập đầy đủ thông tin: Ngày tháng, Người vận chuyển, Số xe.");
                return;
            }

            if (currentOrderKey) {
                const orderRef = ref(db, 'orders-md/' + currentOrderKey);
                update(orderRef, orderData)
                .then(() => {
                    alert('Đã cập nhật lệnh thành công!');
                    showCustomerList();
                })
                .catch(error => {
                    alert('Lỗi khi cập nhật lệnh: ' + error.message);
                });
            } else {
                orderData.createdAt = serverTimestamp();
                orderData.isLocked = false; 
                const ordersRef = ref(db, 'orders-md');
                push(ordersRef, orderData)
                .then(() => {
                    alert('Đã lưu lệnh thành công!');
                    showCustomerList();
                })
                .catch(error => {
                    alert('Lỗi khi lưu lệnh: ' + error.message);
                });
            }
        });

        deleteAllOrdersBtn.addEventListener('click', async () => {
            const password = prompt('CẢNH BÁO: Thao tác này sẽ xóa toàn bộ danh sách lệnh. Vui lòng nhập mật khẩu để xác nhận:');
            if (password === '97531') {
                remove(ref(db, 'orders-md'))
                .then(() => {
                    alert('Đã xóa toàn bộ danh sách lệnh thành công!');
                })
                .catch((error) => {
                    alert('Đã xảy ra lỗi khi xóa toàn bộ danh sách lệnh: ' + error.message);
                });
            } else {
                alert('Mật khẩu không đúng. Vui lòng thử lại.');
            }
        });
        
        importOrdersBtn.addEventListener('click', () => {
            const password = prompt('Vui lòng nhập mật khẩu để nhập danh sách lệnh:');
            if (password === '24680') {
                excelOrderFile.click();
            } else {
                alert('Mật khẩu không đúng. Vui lòng thử lại.');
            }
        });

        excelOrderFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const importedData = XLSX.utils.sheet_to_json(worksheet);

                if (importedData.length === 0) {
                    alert('File Excel không có dữ liệu hoặc cấu trúc không đúng.');
                    return;
                }

                const importPromises = [];
                const ordersRef = ref(db, 'orders-md');
                importedData.forEach(row => {
                    const orderData = {
                        customerName: row['Tên Khách hàng'] || '',
                        date: row['Ngày tháng'] || '',
                        warehouse: row['Kho xuất'] || '',
                        transporter: row['Người vận chuyển'] || '',
                        vehicle: row['Số xe'] || '',
                        lpg45kg: Number(row['LPG 45 kg']) || 0,
                        L45dual: Number(row['LPG 45 kép']) || 0,
                        lpg12kg: Number(row['LPG 12 kg']) || 0,
                        lpg11kg: Number(row['LPG 11 kg']) || 0,
                        chai45kg: Number(row['Chai 45 kg']) || 0,
                        ch45Dual: Number(row['45 kg van kép']) || 0,
                        chai12kg: Number(row['Chai 12 kg']) || 0,
                        chai11kg: Number(row['Chai 11 kg']) || 0,
                        createdAt: serverTimestamp(),
                        isLocked: false 
                    };
                    importPromises.push(push(ordersRef, orderData));
                });

                Promise.all(importPromises)
                    .then(() => {
                        alert(`Đã nhập thành công ${importPromises.length} lệnh từ file Excel!`);
                    })
                    .catch(error => {
                        alert("Đã xảy ra lỗi khi nhập dữ liệu: " + error.message);
                    });
            };
            reader.readAsArrayBuffer(file);
        });
        
        lockOrdersBtn.addEventListener('click', () => {
            const selectedCheckboxes = document.querySelectorAll('#orderTable tbody input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Vui lòng chọn ít nhất một lệnh để khoá.');
                return;
            }

            const confirmation = confirm('Bạn có muốn khoá các lệnh đã chọn? Nếu đã khoá thì không thể quay lại để sửa các lệnh này nữa.');
            
            if (confirmation) {
                const updates = {};
                selectedCheckboxes.forEach(checkbox => {
                    const orderKey = checkbox.dataset.key;
                    updates[`/orders-md/${orderKey}/isLocked`] = true;
                });
                
                update(ref(db), updates)
                    .then(() => {
                        alert('Đã khoá các lệnh đã chọn thành công!');
                    })
                    .catch((error) => {
                        alert('Đã xảy ra lỗi khi khoá lệnh: ' + error.message);
                    });
            }
        });
        
        selectAllOrdersBtn.addEventListener('click', () => {
            const allCheckboxes = document.querySelectorAll('#orderTable tbody input[type="checkbox"]');
            const isAnyUnchecked = Array.from(allCheckboxes).some(cb => !cb.checked);
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = isAnyUnchecked;
            });
        });

        const orderTemplateHTML = `
            <html>
            <head>
            <meta http-equiv=Content-Type content="text/html; charset=utf-8">
            <meta name=Generator content="Microsoft Word 15 (filtered)">
            <style>
            @font-face
                {font-family:"Cambria Math"; panose-1:2 4 5 3 5 4 6 3 2 4;}
            @font-face
                {font-family:Calibri; panose-1:2 15 5 2 2 2 4 3 2 4;}
            @font-face
                {font-family:"Segoe UI"; panose-1:2 11 5 2 4 2 4 2 2 3;}
            p.MsoNormal, li.MsoNormal, div.MsoNormal
                {margin-top:0cm; margin-right:0cm; margin-bottom:8.0pt; margin-left:0cm; line-height:107%; font-size:13.0pt; font-family:"Times New Roman",serif;}
            p.MsoHeader, li.MsoHeader, div.MsoHeader
                {margin:0cm; margin-bottom:.0001pt; font-size:13.0pt; font-family:"Times New Roman",serif;}
            @page WordSection1
                {size:595.3pt 841.9pt; margin:28.4pt 36.0pt 14.2pt 36.0pt;}
            
            div.WordSection1
                {page:WordSection1; position: relative;}
            #print-logo 
                { position: absolute; top: 0cm; left: 0.5cm; width: 1.6cm; height: 1.6cm; }
            </style>
            </head>
            <body lang=VI>
            <div class=WordSection1>
            
            <img id="print-logo" src="https://pvgaslpg.com.vn/uploads/LPG%20xanh%20animation.gif" alt="Logo">

            <p class=MsoHeader align=center style='text-align:center'><b><span lang=EN-US style='font-size:12.0pt'>CÔNG TY CỔ PHẦN KINH DOANH LPG VIỆT NAM</span></b></p>
            <p class=MsoHeader align=center style='text-align:center'><b><span lang=EN-US style='font-size:12.0pt'>CHI NHÁNH MIỀN BẮC</span></b></p>
            <p class=MsoHeader align=center style='text-align:center'><span lang=EN-US style='font-size:12.0pt'>Tầng 11, toà nhà Viện Dầu khí, tầng 11, số 167 Trung Kính, Yên Hòa, Hà Nội</span></p>
            <div style='border:none;border-bottom:solid windowtext 1.0pt;padding:0cm 0cm 1.0pt 0cm'>
            <p class=MsoHeader align=center style='text-align:center;border:none;padding:0cm'><span lang=EN-US style='font-size:12.0pt'>Điện thoại: 024.37667759 - FAX: 024.37667761</span></p>
            </div>
            <p class=MsoNormal align=center style='margin-top:12.0pt;text-align:center'><b><span lang=EN-US style='font-size:16.0pt;line-height:107%'>LỆNH XUẤT HÀNG</span></b></p>
            <p class=MsoNormal align=center style='text-align:center'><b><span lang=EN-US>(KIÊM PHIẾU XUẤT KHO - CÓ GIÁ TRỊ XUẤT HÀNG TRONG NGÀY)</span></b></p>
            <table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0 style='width:212.6pt;margin-left:325.8pt;border-collapse:collapse'>
             <tr style='height:14.3pt'>
              <td width=142 nowrap valign=bottom style='width:106.3pt;border:solid windowtext 1.0pt;border-right:none;padding:0cm 5.4pt 0cm 5.4pt;height:14.3pt'>
              <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><b><span style='font-size:11.0pt;color:black'>Số lệnh xuất hàng:</span></b></p>
              </td>
              <td width=72 nowrap valign=bottom style='width:53.9pt;border:solid windowtext 1.0pt;border-right:none;padding:0cm 5.4pt 0cm 5.4pt;height:14.3pt'>
              <p class=MsoNormal align=right style='margin-bottom:0cm;text-align:right;line-height:normal'><span lang=EN-US style='font-size:11.0pt'>orderNumber</span></p>
              </td>
              <td width=70 nowrap valign=bottom style='width:52.4pt;border:solid windowtext 1.0pt;border-left:none;padding:0cm 5.4pt 0cm 5.4pt;height:14.3pt'>
              <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><b><span style='font-size:11.0pt;color:black'>/KMĐ</span></b></p>
              </td>
             </tr>
             <tr style='height:17.3pt'>
              <td width=142 nowrap valign=bottom style='width:106.3pt;border-top:none;border-left:solid windowtext 1.0pt;border-bottom:solid windowtext 1.0pt;border-right:none;padding:0cm 5.4pt 0cm 5.4pt;height:17.3pt'>
              <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><b><span style='font-size:11.0pt;color:black'>Ngày</span></b></p>
              </td>
              <td width=142 nowrap colspan=2 valign=bottom style='width:106.3pt;border-top:none;border-left:solid windowtext 1.0pt;border-bottom:solid windowtext 1.0pt;border-right:solid black 1.0pt;padding:0cm 5.4pt 0cm 5.4pt;height:17.3pt'>
              <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span lang=EN-US>date</span></p>
              </td>
             </tr>
            </table>
            <p class=MsoNormal style='margin-bottom:0cm;text-align:center;line-height:normal'><b><span lang=EN-US>&nbsp;</span></b></p>
            
            <table class=MsoNormalTable border=1 cellspacing=0 cellpadding=0 width="100%" style='width:100%;border-collapse:collapse; border: 1px solid windowtext; font-size:11.0pt'>
                 <tr style="vertical-align: top;">
                  <td colspan=4 style="padding: 5px;"><b>KHÁCH HÀNG:</b><br><br>customerName</td>
                  <td colspan=2 style="padding: 5px;"><b>Người nhận hàng:</b><br>customerName</td>
                 </tr>
                 <tr>
                  <td colspan=4 rowspan=2 style="border-top: none; padding: 5px; vertical-align: top;">deliveryLocation</td>
                  <td style="padding: 5px;">Số CCCD</td>
                  <td style="padding: 5px;">&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px;">Điện Thoại</td>
                  <td style="padding: 5px;">&nbsp;</td>
                 </tr>
                 <tr style="vertical-align: top;">
                  <td colspan=4 style="padding: 5px;"><b>KHO XUẤT HÀNG:</b></td>
                  <td style="padding: 5px;"><b>Người vận chuyển:</b></td>
                  <td style="padding: 5px;">transporter</td>
                 </tr>
                 <tr>
                  <td colspan=4 rowspan=2 style="border-top: none;">&nbsp;KHO MỸ ĐÌNH</td>
                  <td style="padding: 5px;">Số CCCD</td>
                  <td style="padding: 5px;">&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px;">Điện Thoại</td>
                  <td style="padding: 5px;">&nbsp;</td>
                 </tr>
                 <tr>
                  <td colspan=4 style="border-top: none;">&nbsp;</td>
                  <td style="padding: 5px;"><b>Số xe:</b></td>
                  <td style="padding: 5px;">vehicle</td>
                 </tr>
                 <tr style='text-align:center; font-weight: bold;'>
                  <td style="padding: 5px;">Tên Hàng</td>
                  <td style="padding: 5px;">Nhãn hiệu</td>
                  <td style="padding: 5px;">Số chai</td>
                  <td style="padding: 5px;">LPG (kg)</td>
                  <td colspan=2 style="padding: 5px;">GHI CHÚ</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">LPG chai 45 kg</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>lpg45kg</td>
                  <td style='text-align:right; padding-right: 5px;'>Tich1</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">LPG chai 45 van kép</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>L45dual</td>
                  <td style='text-align:right; padding-right: 5px;'>Tich4</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">LPG chai 12 kg</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>lpg12kg</td>
                  <td style='text-align:right; padding-right: 5px;'>Tich2</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">LPG chai 11 kg</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>lpg11kg</td>
                  <td style='text-align:right; padding-right: 5px;'>Tich3</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px;"><b>Tổng lượng LPG</b></td>
                  <td>&nbsp;</td>
                  <td style='text-align:center;'><b>Sumchai</b></td>
                  <td style='text-align:right; padding-right: 5px;'><b>Sumtich</b></td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Chai LPG 45 kg</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>chai45kg</td>
                  <td>&nbsp;</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Chai LPG 45 kg van kép</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>ch45Dual</td>
                  <td>&nbsp;</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Chai LPG 12 kg</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>chai12kg</td>
                  <td>&nbsp;</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
                 <tr>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Chai LPG 11 kg</td>
                  <td style="padding: 5px; white-space: nowrap; word-break: keep-all;">Petrovietnam Gas</td>
                  <td style='text-align:center;'>chai11kg</td>
                  <td>&nbsp;</td>
                  <td colspan=2>&nbsp;</td>
                 </tr>
            </table>

            <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span lang=EN-US>&nbsp;</span></p>
            <table class=MsoNormalTable border=1 cellspacing=0 cellpadding=0 width="100%" style='width:100%;border-collapse:collapse; border: 1px solid windowtext; text-align:center; font-size:11.0pt'>
                 <tr style='font-weight: bold;'>
                  <td style="padding: 5px;">Phòng TC-KT</td>
                  <td style="padding: 5px;">Phòng KH-KD</td>
                  <td style="padding: 5px;">Giám đốc/ Người được ủy quyền</td>
                 </tr>
                 <tr style='height: 80pt;'>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                 </tr>
            </table>
            <p class=MsoNormal style='margin-bottom:0cm;line-height:normal'><span lang=EN-US>&nbsp;</span></p>
            <table class=MsoNormalTable border=1 cellspacing=0 cellpadding=0 width="100%" style='width:100%;border-collapse:collapse; border: 1px solid windowtext; text-align:center; font-size:11.0pt'>
                 <tr>
                  <td colspan=2 style='font-weight: bold; padding: 5px;'>Người giao hàng</td>
                  <td style='font-weight: bold; padding: 5px;'>Người nhận hàng</td>
                 </tr>
                 <tr style='font-weight: bold;'>
                  <td style="padding: 5px;">Quản đốc trạm nạp</td>
                  <td style="padding: 5px;">Thủ kho</td>
                  <td style="padding: 5px;">Lái xe nhận hàng</td>
                 </tr>
                 <tr style='height: 80pt;'>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                 </tr>
            </table>
            <p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>
            </div>
            </body>
            </html>
        `;

        const setupOrderInputFields = () => {
            const numberInputs = [
                orderLpg45kgInput,
                orderL45dualInput,
                orderLpg12kgInput,
                orderLpg11kgInput,
                order45kgInput,
                orderch45DualInput,
                order12kgInput,
                order11kgInput
            ];

            numberInputs.forEach((input, index) => {
                input.addEventListener('focus', () => {
                    input.select();
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = numberInputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        } else {
                             submitOrderBtn.focus();
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const prevInput = numberInputs[index - 1];
                        if (prevInput) {
                            prevInput.focus();
                        }
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const nextInput = numberInputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                });

                input.addEventListener('input', () => {
                    if (input.value < 0) {
                        input.value = 0;
                    }
                });
            });
        };

        const printOrder = (orderData) => {
            const tich1 = orderData.lpg45kg * 45;
            const tich2 = orderData.lpg12kg * 12;
            const tich3 = orderData.lpg11kg * 11;
            const tich4 = orderData.L45dual * 45;
            const sumChai = orderData.lpg45kg + orderData.L45dual + orderData.lpg12kg + orderData.lpg11kg;
            const sumTich = tich1 + tich4 + tich2 + tich3;

            const replacements = {
                orderNumber: orderData.orderNumber,
                date: orderData.date,
                customerName: orderData.customerName,
                transporter: orderData.transporter,
                vehicle: orderData.vehicle,
                deliveryLocation: orderData.deliveryLocation || '',
                lpg45kg: orderData.lpg45kg,
                L45dual: orderData.L45dual,
                lpg12kg: orderData.lpg12kg,
                lpg11kg: orderData.lpg11kg,
                chai45kg: orderData.chai45kg,
                ch45Dual: orderData.ch45Dual,
                chai12kg: orderData.chai12kg,
                chai11kg: orderData.chai11kg,
                Tich1: tich1,
                Tich2: tich2,
                Tich3: tich3,
                Tich4: tich4,
                Sumchai: sumChai,
                Sumtich: sumTich
            };

            let finalHTML = orderTemplateHTML;
            for (const key in replacements) {
                const regex = new RegExp(key, 'g');
                finalHTML = finalHTML.replace(regex, replacements[key]);
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(finalHTML);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        };

        const renderOrdersForPage = (pageNumber) => {
            orderTableBody.innerHTML = '';
            const totalOrders = allOrders.length;
            const startIndex = (pageNumber - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalOrders);
            const ordersToDisplay = allOrders.slice(startIndex, endIndex);

            const totalPages = Math.ceil(totalOrders / ITEMS_PER_PAGE);
            
            pageInfoSpan.textContent = `Trang ${pageNumber}/${totalPages || 1}`;
            prevPageBtn.disabled = pageNumber === 1;
            nextPageBtn.disabled = pageNumber === totalPages || totalOrders === 0;

            ordersToDisplay.forEach((order) => {
                const row = orderTableBody.insertRow();
                
                if (order.isLocked) {
                    row.classList.add('locked-order');
                }
                
                const checkboxCell = row.insertCell(0);
                checkboxCell.classList.add('checkbox-col');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.key = order.key; 
                checkboxCell.appendChild(checkbox);

                row.insertCell(1).textContent = order.orderNumber;
                row.insertCell(2).textContent = order.customerName;
                row.insertCell(3).textContent = order.date;
                row.insertCell(4).textContent = order.warehouse;
                row.insertCell(5).textContent = order.vehicle;
                row.insertCell(6).textContent = order.lpg45kg;
                row.insertCell(7).textContent = order.L45dual;
                row.insertCell(8).textContent = order.lpg12kg;
                row.insertCell(9).textContent = order.lpg11kg;
                row.insertCell(10).textContent = order.chai45kg;
                row.insertCell(11).textContent = order.ch45Dual;
                row.insertCell(12).textContent = order.chai12kg;
                row.insertCell(13).textContent = order.chai11kg;
                
                const actionsCell = row.insertCell(14);
                actionsCell.classList.add('action-buttons');

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Sửa lệnh';
                editBtn.className = 'edit-btn';
                
                if (order.isLocked) {
                    editBtn.disabled = true;
                }
                
                editBtn.addEventListener('click', () => {
                    const password = prompt('Vui lòng nhập mật khẩu để sửa lệnh:');
                    if (password === '00000') {
                        showEditOrderForm(order.key, order);
                    } else {
                        alert('Mật khẩu không đúng. Vui lòng thử lại.');
                    }
                });
                actionsCell.appendChild(editBtn);
                
                const printBtn = document.createElement('button');
                printBtn.textContent = 'In lệnh';
                printBtn.className = 'print-btn';

                printBtn.addEventListener('click', () => {
                    printOrder(order); 
                });
                actionsCell.appendChild(printBtn);
            });
        };

        const ordersQuery = query(ref(db, 'orders-md'), orderByChild('createdAt'));
        onValue(ordersQuery, (snapshot) => {
            allOrders = [];
            if(snapshot.exists()) {
                const ordersObject = snapshot.val();
                for (const key in ordersObject) {
                    allOrders.push({ ...ordersObject[key], key: key, orderNumber: 0 });
                }
            }
            
            allOrders.forEach((order, index) => {
                order.orderNumber = index + 1;
            });

            allOrders.reverse();

            const totalPages = Math.ceil(allOrders.length / ITEMS_PER_PAGE);
            currentPage = 1;
            renderOrdersForPage(currentPage);
        });

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderOrdersForPage(currentPage);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(allOrders.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderOrdersForPage(currentPage);
            }
        });

        // Bắt đầu: Cập nhật chức năng xuất Excel
        showStatisticsBtn.addEventListener('click', () => {
            if (allOrders.length === 0) {
                alert('Không có dữ liệu để xuất file Excel.');
                return;
            }

            const processedData = allOrders.map(order => ({
                'Số thứ tự': order.orderNumber,
                'Tên Khách hàng': order.customerName,
                'Ngày tháng': order.date,
                'Kho xuất': order.warehouse,
                'Người vận chuyển': order.transporter,
                'Số xe': order.vehicle,
                'Địa điểm giao hàng': order.deliveryLocation || '', // Thêm trường mới vào đây
                'LPG 45 kg': order.lpg45kg,
                'LPG 45 kép': order.L45dual,
                'LPG 12 kg': order.lpg12kg,
                'LPG 11 kg': order.lpg11kg,
                'Chai 45 kg': order.chai45kg,
                '45 kg van kép': order.ch45Dual,
                'Chai 12 kg': order.chai12kg,
                'Chai 11 kg': order.chai11kg
            }));

            const worksheet = XLSX.utils.json_to_sheet(processedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ThongKeLenh");
            XLSX.writeFile(workbook, "thong-ke-toan-bo-lenh.xlsx");
        });
        // Kết thúc: Cập nhật chức năng xuất Excel
    </script>
</body>
</html>
